import{_ as de,u as ue,r as v,b as O,H as ce,j as pe,c as L,d as c,t as p,e as n,l as a,f as B,p as l,q as d,g as me,I as _e,J as x,K as N,L as ge,m as k,s as fe,M as be,o as f,N as J,O as $,P as ve,Q as g,R as he,S as ye,T as Le}from"./index-D3SxXfTO.js";const ke={class:"page-container"},we={class:"page-header"},Ce={class:"page-title"},De={class:"filter-container"},Se={key:0,class:"active-filters"},Te={class:"table-container"},Ve={class:"user-card"},Ie={class:"user-info"},xe={class:"label"},Ne={key:1},Pe={class:"details-dialog-content"},ze=["innerHTML"],je={class:"dialog-footer"},Me={class:"pagination-container"},Re={__name:"AuditLog",setup(Ye){const{t:e}=ue();fe();const P=[{key:"user",label:e("auditLog.modules.user")},{key:"auth",label:e("auditLog.modules.auth")},{key:"product",label:e("auditLog.modules.product")},{key:"feature",label:e("auditLog.modules.feature")},{key:"license_type",label:e("auditLog.modules.license_type")},{key:"firmware_version",label:e("auditLog.modules.firmware_version")},{key:"software_version",label:e("auditLog.modules.software_version")},{key:"device",label:e("auditLog.modules.device")}],z=[{key:"create",label:e("auditLog.actions.create")},{key:"update",label:e("auditLog.actions.update")},{key:"delete",label:e("auditLog.actions.delete")},{key:"login",label:e("auditLog.actions.login")},{key:"register",label:e("auditLog.actions.register")}],T=v(!1),j=v(!1),V=v([]),E=v([]),_=O({currentPage:1,pageSize:10,total:0}),i=O({timeRange:[],module:"",operation:"",productId:null}),w=v(!1),C=v(""),M=v(""),F=[{text:e("auditLog.filter.shortcuts.lastWeek"),value:()=>{const r=new Date,t=new Date;return t.setTime(t.getTime()-3600*1e3*24*7),[t,r]}},{text:e("auditLog.filter.shortcuts.lastMonth"),value:()=>{const r=new Date,t=new Date;return t.setTime(t.getTime()-3600*1e3*24*30),[t,r]}},{text:e("auditLog.filter.shortcuts.lastThreeMonths"),value:()=>{const r=new Date,t=new Date;return t.setTime(t.getTime()-3600*1e3*24*90),[t,r]}}],U=(r,t,u)=>u?N(u).format("YYYY-MM-DD HH:mm:ss"):"",Z=()=>{h()},D=async()=>{var r;T.value=!0;try{const t={page:_.currentPage,page_size:_.pageSize,module:i.module,operation:i.operation,product_id:i.productId};((r=i.timeRange)==null?void 0:r.length)===2&&(t.start_time=N(i.timeRange[0]).format(),t.end_time=N(i.timeRange[1]).format());const u=await ge.list(t);V.value=(u.data.list||[]).map(s=>({id:s.id,userId:s.user_id,userEmail:s.user_email,module:s.module,operation:s.operation,productId:s.product_id,productName:s.product_name,detail:s.detail,ipAddress:s.ip_address,createdAt:s.created_at})),_.total=u.data.total||0}catch(t){k.error(t.message||"加载数据失败","server")}finally{T.value=!1}};ce(async r=>{if(!(r.length<2)){j.value=!0;try{const t=await be.search({keyword:r});E.value=t.data.list||[]}catch(t){k.error(t.message,"server")}finally{j.value=!1}}},300);const K=r=>{try{let t=r;typeof r=="string"&&(t=JSON.parse(r)),C.value=t,M.value=JSON.stringify(t,null,2).replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,u=>{let s="json-value";return/^"/.test(u)?s=/:$/.test(u)?"json-key":"json-string":/true|false|null/.test(u)?s="json-literal":/^-?\d+/.test(u)&&(s="json-number"),`<span class="${s}">${u}</span>`}),w.value=!0}catch(t){console.error("解析JSON失败:",t),k.error(e("auditLog.error.invalidJson","server"))}},Q=async()=>{try{await navigator.clipboard.writeText(typeof C.value=="string"?C.value:JSON.stringify(C.value,null,2)),k.success(e("common.copySuccess"))}catch{k.error(e("common.copyFailed"),"server")}},W=r=>{i.productId=r,h()},R=()=>{i.productId=null,h()},q=r=>{const t=V.value.find(u=>u.productId===r);return t?t.productName:r},h=()=>{_.currentPage=1,D()},G=r=>{_.pageSize=r,_.currentPage=1,D()},X=r=>{_.currentPage=r,D()};return pe(()=>{D()}),(r,t)=>{const u=d("el-date-picker"),s=d("el-form-item"),Y=d("el-option"),A=d("el-select"),S=d("el-icon"),y=d("el-button"),ee=d("el-form"),te=d("el-tag"),b=d("el-table-column"),ae=d("el-popover"),H=d("el-dropdown-item"),le=d("el-dropdown-menu"),oe=d("el-dropdown"),ne=d("el-table"),re=d("el-dialog"),se=d("el-pagination"),ie=_e("loading");return f(),L("div",ke,[c("div",we,[c("h2",Ce,p(n(e)("auditLog.title")),1)]),c("div",De,[a(ee,{inline:!0,class:"filter-form"},{default:l(()=>[a(s,{label:n(e)("auditLog.filter.timeRange"),class:"form-item-time"},{default:l(()=>[a(u,{modelValue:i.timeRange,"onUpdate:modelValue":t[0]||(t[0]=o=>i.timeRange=o),type:"datetimerange","start-placeholder":n(e)("auditLog.filter.startTime"),"end-placeholder":n(e)("auditLog.filter.endTime"),shortcuts:F,"value-format":"YYYY-MM-DDTHH:mm:ss.SSSZ","range-separator":"至",onChange:Z,style:{width:"380px"}},null,8,["modelValue","start-placeholder","end-placeholder"])]),_:1},8,["label"]),a(s,{label:n(e)("auditLog.filter.module"),class:"form-item"},{default:l(()=>[a(A,{modelValue:i.module,"onUpdate:modelValue":t[1]||(t[1]=o=>i.module=o),clearable:"",onChange:h,style:{width:"180px"},placeholder:n(e)("auditLog.filter.modulePlaceholder")},{default:l(()=>[(f(),L(J,null,$(P,(o,m)=>a(Y,{key:m,label:o.label,value:o.key},null,8,["label","value"])),64))]),_:1},8,["modelValue","placeholder"])]),_:1},8,["label"]),a(s,{label:n(e)("auditLog.filter.action"),class:"form-item"},{default:l(()=>[a(A,{modelValue:i.operation,"onUpdate:modelValue":t[2]||(t[2]=o=>i.operation=o),clearable:"",onChange:h,style:{width:"180px"},placeholder:n(e)("auditLog.filter.actionPlaceholder")},{default:l(()=>[(f(),L(J,null,$(z,(o,m)=>a(Y,{key:m,label:o.label,value:o.key},null,8,["label","value"])),64))]),_:1},8,["modelValue","placeholder"])]),_:1},8,["label"]),a(s,{class:"search-btn-item"},{default:l(()=>[a(y,{type:"primary",circle:"",onClick:h},{default:l(()=>[a(S,null,{default:l(()=>[a(n(ve))]),_:1})]),_:1})]),_:1})]),_:1}),i.productId?(f(),L("div",Se,[a(te,{closable:"",onClose:R},{default:l(()=>[g(p(n(e)("auditLog.filter.filteredByProduct"))+": "+p(q(i.productId)),1)]),_:1})])):B("",!0)]),c("div",Te,[me((f(),x(ne,{data:V.value,style:{width:"100%"},border:"",stripe:"","header-cell-style":{background:"#f5f7fa"}},{default:l(()=>[a(b,{label:n(e)("auditLog.table.time"),prop:"createdAt",width:"200",formatter:U},null,8,["label"]),a(b,{label:n(e)("auditLog.table.operator"),"min-width":"180"},{default:l(({row:o})=>[a(ae,{placement:"right",width:300,trigger:"click"},{reference:l(()=>[a(y,{link:"",type:"primary"},{default:l(()=>[g(p(o.userEmail),1)]),_:2},1024)]),default:l(()=>[c("div",Ve,[c("h3",null,p(n(e)("auditLog.userCard.title")),1),c("div",Ie,[c("p",null,[c("span",xe,p(n(e)("auditLog.userCard.email"))+":",1),c("span",null,p(o.userEmail),1)])])])]),_:2},1024)]),_:1},8,["label"]),a(b,{label:n(e)("auditLog.table.module"),prop:"module","min-width":"150"},{default:l(({row:o})=>{var m;return[g(p(((m=P.find(I=>I.key===o.module))==null?void 0:m.label)||o.module),1)]}),_:1},8,["label"]),a(b,{label:n(e)("auditLog.table.action"),prop:"operation","min-width":"120"},{default:l(({row:o})=>{var m;return[g(p(((m=z.find(I=>I.key===o.operation))==null?void 0:m.label)||o.operation),1)]}),_:1},8,["label"]),a(b,{label:n(e)("auditLog.table.product"),"min-width":"180"},{default:l(({row:o})=>[o.productId?(f(),x(oe,{key:0,trigger:"click"},{dropdown:l(()=>[a(le,null,{default:l(()=>[a(H,{onClick:m=>W(o.productId)},{default:l(()=>[a(S,null,{default:l(()=>[a(n(ye))]),_:1}),g(" "+p(n(e)("auditLog.product.filter")),1)]),_:2},1032,["onClick"]),i.productId?(f(),x(H,{key:0,onClick:R,divided:""},{default:l(()=>[a(S,null,{default:l(()=>[a(n(Le))]),_:1}),g(" "+p(n(e)("auditLog.product.clearFilter")),1)]),_:1})):B("",!0)]),_:2},1024)]),default:l(()=>[a(y,{type:"primary",link:""},{default:l(()=>[g(p(o.productName)+" ",1),a(S,{class:"el-icon--right"},{default:l(()=>[a(n(he))]),_:1})]),_:2},1024)]),_:2},1024)):(f(),L("span",Ne,"-"))]),_:1},8,["label"]),a(b,{label:n(e)("auditLog.table.ip"),prop:"ipAddress","min-width":"180"},null,8,["label"]),a(b,{label:n(e)("auditLog.table.details"),width:"120",align:"left"},{default:l(({row:o})=>[a(y,{link:"",type:"primary",onClick:m=>K(o.detail)},{default:l(()=>[g(p(n(e)("auditLog.viewDetails")),1)]),_:2},1032,["onClick"])]),_:1},8,["label"])]),_:1},8,["data"])),[[ie,T.value]]),a(re,{modelValue:w.value,"onUpdate:modelValue":t[4]||(t[4]=o=>w.value=o),title:n(e)("auditLog.detailsDialog.title"),width:"60%"},{footer:l(()=>[c("div",je,[a(y,{type:"primary",onClick:Q},{default:l(()=>[g(p(n(e)("auditLog.detailsDialog.copy")),1)]),_:1}),a(y,{onClick:t[3]||(t[3]=o=>w.value=!1)},{default:l(()=>[g(p(n(e)("common.cancel")),1)]),_:1})])]),default:l(()=>[c("div",Pe,[c("pre",null,[c("code",{class:"hljs json",innerHTML:M.value},null,8,ze)])])]),_:1},8,["modelValue","title"]),c("div",Me,[a(se,{"current-page":_.currentPage,"page-size":_.pageSize,"page-sizes":[10,20,50,100],total:_.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:G,onCurrentChange:X},null,8,["current-page","page-size","total"])])])])}}},He=de(Re,[["__scopeId","data-v-f87629c3"]]);export{He as default};
